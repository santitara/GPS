<!DOCTYPE html><html>
<meta charset="utf-8" />
<head>
	<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />

 <style>
  #map { 
  widh: 50px;
  height: 600px; }
 </style>
 
 </head>
  <body>
   <div id="map"></div>
   <div id="buttons">
    <label for="cars">Choose a imei:</label>
    <select name="cars" id="imei_select" onchange="get_data()">
    </select>
    <label for="date ini">Choose a initial date:</label>
    <select name="date_ini" id="date_ini">
    </select>
    <label for="date end">Choose a end date:</label>
    <select name="date_end" id="date_end">
    </select>
    <br><br>
    <input type="button" value="plot data" onclick="plot_data()">
   </div>
 <script>

const URL='http://192.168.0.19:8080/';
console.log( Math.round(new Date().getTime()/1000));


function convert_timestamp(timestamp)
{

  var currentDate = new Date();
  var date = currentDate.getDate();
  var month = currentDate.getMonth(); //Be careful! January is 0 not 1
  var year = currentDate.getFullYear();
  var hour = currentDate.getHours();
  var min = currentDate.getMinutes();
  var sec = currentDate.getSeconds();

  var dateString = date + "-" +(month + 1) + "-" + year + " "+hour+":"+min+":"+sec;
  console.log(dateString);
}

window.onload = window.onload = get_imeis; 


function get_imeis()
{
  var imeis = [];
  const Http = new XMLHttpRequest();
  const url=URL+'imeis';
  Http.open("GET", url);
  Http.send();
  Http.onreadystatechange = (e) => {
    console.log(Http.responseText)
    if(Http.readyState == 4)
    {
      var imeis = JSON.parse(Http.responseText);
      fill_imeis_box(imeis);
      get_data();
    }
  }
      
}

function fill_date_box(date)
{
  var sel_1 = document.getElementById('date_ini');
  var sel_2 = document.getElementById('date_end');
  sel_1.innerHTML = "";
  sel_2.innerHTML = "";
  for(var i = 0; i < date.length; i++) {
      var opt = document.createElement('option');
      var time = timeConverter(date[i].timestamp);
      opt.innerHTML = time;
      opt.value = date[i].timestamp;
      sel_1.appendChild(opt);
      //sel_2.appendChild(opt);
  }
  for(var i = 0; i < date.length; i++) {
      var opt = document.createElement('option');
      var time = timeConverter(date[i].timestamp);
      opt.innerHTML = time;
      opt.value = date[i].timestamp;
      //sel_1.appendChild(opt);
      sel_2.appendChild(opt);
  }
}


function timeConverter(UNIX_timestamp){
  var a = new Date(UNIX_timestamp * 1000);
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var year = a.getFullYear();
  var month = months[a.getMonth()];
  var date = a.getDate();
  var hour = a.getHours();
  var min = a.getMinutes();
  var sec = a.getSeconds();
  var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec ;
  return time;
}
function fill_imeis_box(imeis)
{
  var sel = document.getElementById('imei_select');
  for(var i = 0; i < imeis.length; i++) {
      var opt = document.createElement('option');
      opt.innerHTML = imeis[i].imei;
      opt.value = imeis[i].imei;
      sel.appendChild(opt);
  }

}



var map = L.map('map').
setView([41.66, -4.72], 
5);
 
L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
    maxZoom: 18
}).addTo(map);

L.control.scale().addTo(map);
// L.marker([41.66, -4.71], {draggable: true}).addTo(map);

//  var pointA = new L.LatLng(41.635308, -4.22496);
//  var pointB = new L.LatLng(42.984461, -4.70641);
//  var pointList = [pointA, pointB];
// works  fine and draw a static line on any leaflet map with IP Geolocation.

//var pointList = ????; //what should be this value to pull IP Geolocation markers latlng corresponding to my View ?

//var firstpolyline = new L.Polyline(pointList);
//firstpolyline.addTo(map);

var centerLng = 31.633004916540266;
var centerLat = -7.997800602958748;
//var map = L.map('map').setView([centerLng,centerLat], 15);
// var collection = [];
// var geojsonlist = [];

// L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
//     attribution: '<a style="color:#000" target="_blank" href="http://www.alikilic.org">Ali KILIÇ</a> | <a style="color:#000" href="mailto:alikilicharita@gmail.com">alikilicharita@gmail.com</a>'
// }).addTo(map);

// var geojson = {
// "type": "FeatureCollection",
// "name": "test",
// "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
// "features": [
// { "type": "Feature", "properties": { "id": 0, "nom": "JAMAA EL FNA", "ligne": "L1", "ville": "MARRAKECH", "direction": "A" }, "geometry": { "type": "Point", "coordinates": [ -7.991506070410076, 31.624380871588261 ] } },
// { "type": "Feature", "properties": { "id": 1, "nom": "KOUTOUBIA", "ligne": "L1", "ville": "MARRAKECH", "direction": "A" }, "geometry": { "type": "Point", "coordinates": [ -7.993921192850516, 31.62551706188404 ] } },
// { "type": "Feature", "properties": { "id": 2, "nom": "HOTE DE VILLE", "ligne": "L1", "ville": "MARRAKECH", "direction": "A" }, "geometry": { "type": "Point", "coordinates": [ -7.997800602958748, 31.627492814514493 ] } },
// { "type": "Feature", "properties": { "id": 3, "nom": "R.P BERDII", "ligne": "L1", "ville": "MARRAKECH", "direction": "A" }, "geometry": { "type": "Point", "coordinates": [ -8.003733858117105, 31.630010280990067 ] } },
// { "type": "Feature", "properties": { "id": 4, "nom": "GRAND POSTE", "ligne": "L1", "ville": "MARRAKECH", "direction": "A" }, "geometry": { "type": "Point", "coordinates": [ -8.009040991276375, 31.633004916540266 ] } },
// { "type": "Feature", "properties": { "id": 5, "nom": "CAREE EDEN", "ligne": "L1", "ville": "MARRAKECH", "direction": "A" }, "geometry": { "type": "Point", "coordinates": [ -8.011327830139466, 31.634311225216251 ] } },
// { "type": "Feature", "properties": { "id": 6, "nom": "PL ABDELMOUMEN", "ligne": "L1", "ville": "MARRAKECH", "direction": "A" }, "geometry": { "type": "Point", "coordinates": [ -8.01491129321975, 31.63631744889955 ] } },
// { "type": "Feature", "properties": { "id": 7, "nom": "PLACE D ARMES", "ligne": "L1", "ville": "MARRAKECH", "direction": "A" }, "geometry": { "type": "Point", "coordinates": [ -8.017961238223567, 31.63862644522986 ] } },
// { "type": "Feature", "properties": { "id": 8, "nom": "FST", "ligne": "L1", "ville": "MARRAKECH", "direction": "A" }, "geometry": { "type": "Point", "coordinates": [ -8.019317263334594, 31.64420691382918 ] } }]};

  var lineCoordinate = [];
  var lineCoordinate_ms = [];
// for(var i in geojson.features){
//   var pointJson = geojson.features[i];
//   var coord = pointJson.geometry.coordinates;
//   //L.marker([coord[1],coord[0]]).addTo(map);
//   lineCoordinate.push([coord[1],coord[0]]);
// }



// //debugger;
 L.polyline(lineCoordinate, {color: 'red'}).addTo(map);

function plot_gps_data(coordinates)
{
  //map.setView([coord_lat, coord_lon], 14);
  for(var i in coordinates)
  {
    var pointJson = coordinates[i];
    var coord_lat = pointJson.latitude;
    var coord_lon = pointJson.longitude;
    //L.marker([coord[1],coord[0]]).addTo(map);
    lineCoordinate_ms.push([coord_lat,coord_lon]);
  }
  map.setView([coord_lat, coord_lon], 14);
  L.polyline(lineCoordinate_ms, {color: 'red'}).addTo(map);
}
/*function get_data ()
{
  var xmlHttp = new XMLHttpRequest();
  xmlHttp.open( "GET", 'http://192.168.0.19:8080/data_gps?imei=867717036600832&timestamp=1', false ); // false for synchronous request
  xmlHttp.setRequestHeader('Access-Control-Allow-Origin', '*');
  xmlHttp.send();
  console.log (xmlHttp.responseText);
  
}*/
var data_gps = [];

function get_data ()
{
  var select = document.getElementById("imei_select");
  select = select.options[select.selectedIndex].value;

  const Http = new XMLHttpRequest();
  const url=URL+'coordinates?imei='+select;
  Http.open("GET", url);
  Http.send();
  Http.onreadystatechange = (e) => {
    if(Http.readyState == 4)
    {
      //console.log(Http.responseText)
      data_gps = JSON.parse(Http.responseText);
      //plot_gps_data(data);
      fill_date_box(data_gps);
    }
  }
}

function plot_data()
{
  var date_ini = document.getElementById("date_ini");
  date_ini = date_ini.options[date_ini.selectedIndex].value;
  var date_end = document.getElementById("date_end");
  date_end = date_end.options[date_end.selectedIndex].value;

  if(date_ini>date_end)
  {
    alert("error la fecha final tiene que ser mayor a la inicial");
    return;
  }
  var data_cordinates = [];
  var imei = document.getElementById("imei_select");
  imei = imei.options[imei.selectedIndex].value;
  const Http = new XMLHttpRequest();
  const url=URL+'coordinates?imei='+imei+'?date_ini='+date_ini+'?date_end='+date_end;
  Http.open("GET", url);
  Http.send();
  Http.onreadystatechange = (e) => {
    if(Http.readyState == 4)
    {
      //console.log(Http.responseText)
      data_cordinates = JSON.parse(Http.responseText);
      plot_gps_data(data_cordinates);
    }
  }



}

/*function httpGetAsync(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", theUrl, true); // true for asynchronous 
    xmlHttp.send(null);
}*/




 </script>
 </body> 
 </html>